<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORA GCN 在线实践 - 图学习算法实践与教程</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link href="css/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- 导航栏 -->
    <nav class="gradient-bg shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="w-8 h-8 text-white mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-white text-xl font-bold">GraphLearn</span>
                    </div>
                    <div class="hidden md:block ml-10">
                        <div class="flex space-x-8">
                            <a href="index.html" class="nav-link text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">首页</a>
                            <a href="tutorials.html" class="nav-link text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">教程</a>
                            <a href="playground.html" class="nav-link text-blue-200 px-3 py-2 rounded-md text-sm font-medium">在线实践</a>
                            <a href="community.html" class="nav-link text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">社区</a>
                            <a href="resources.html" class="nav-link text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">资源</a>
                            <a href="game.html" class="nav-link text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">答题闯关</a>
                            <a href="team.html" class="nav-link text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">团队</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main>
        <!-- 页面标题 -->
        <div class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">CORA数据集GCN节点分类</h1>
                <p class="mt-2 text-lg text-gray-600">在浏览器中直接运行图卷积网络(GCN)进行节点分类任务</p>
            </div>
        </div>

        <!-- 主要内容 -->
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- 实验控制面板 -->
            <div class="bg-white rounded-lg shadow mb-6 p-6">
                <h2 class="text-xl font-semibold mb-4">实验控制</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">隐藏层维度</label>
                        <input type="number" id="hidden_dim" value="16" min="8" max="256" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">学习率</label>
                        <input type="number" id="learning_rate" value="0.01" step="0.001" min="0.001" max="0.1"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">训练轮数</label>
                        <input type="number" id="epochs" value="100" min="10" max="500" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="loadCoraData()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        加载数据集
                    </button>
                    <button onclick="runGCN()" 
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        开始训练
                    </button>
                    <button onclick="stopTraining()" 
                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        停止训练
                    </button>
                </div>
            </div>

            <!-- 布局主区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 左侧面板：代码编辑器 -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">GCN 实现代码</h3>
                    </div>
                    <div class="p-4">
                        <textarea id="code-editor" class="w-full h-96 font-mono text-sm"></textarea>
                    </div>
                </div>

                <!-- 右侧面板：结果可视化 -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">训练结果</h3>
                    </div>
                    <div class="p-4">
                        <!-- 训练日志 -->
                        <div class="bg-gray-50 rounded p-4 mb-4 h-32 overflow-y-auto">
                            <div id="train-log" class="text-sm font-mono">准备就绪...
                            </div>
                        </div>
                        
                        <!-- 准确率图表 -->
                        <div id="accuracy-plot" class="h-64 mb-4"></div>
                        
                        <!-- 损失图表 -->
                        <div id="loss-plot" class="h-64 mb-4"></div>
                    </div>
                </div>
            </div>

            <!-- 图可视化区域 -->
            <div class="mt-6 bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">图结构可视化</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 原始图结构 -->
                    <div>
                        <h4 class="text-md font-medium mb-2">原始CORA图结构</h4>
                        <div id="original-graph" class="h-96 border rounded bg-gray-50"></div>
                    </div>
                    
                    <!-- 节点分类结果 -->
                    <div>
                        <h4 class="text-md font-medium mb-2">GCN分类结果</h4>
                        <div id="classification-result" class="h-96 border rounded bg-gray-50"></div>
                    </div>
                </div>
            </div>

            <!-- 性能指标 -->
            <div class="mt-6 bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">性能指标</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-green-50 rounded">
                        <div class="text-2xl font-bold text-green-600" id="train-acc">0.0%</div>
                        <div class="text-sm text-gray-600">训练准确率</div>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded">
                        <div class="text-2xl font-bold text-blue-600" id="val-acc">0.0%</div>
                        <div class="text-sm text-gray-600">验证准确率</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded">
                        <div class="text-2xl font-bold text-purple-600" id="test-acc">0.0%</div>
                        <div class="text-sm text-gray-600">测试准确率</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let pyodide;
        let trainingActive = false;

        // 初始化Pyodide
        async function loadPyodide() {
            if (pyodide) return pyodide;
            
            const loader = document.createElement('div');
            loader.id = 'pyodide-loader';
            loader.innerHTML = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white rounded p-4">正在加载Python环境...</div></div>';
            document.body.appendChild(loader);

            pyodide = await loadPyodide();
            await pyodide.loadPackage(['numpy', 'scipy', 'matplotlib', 'pandas']);
            
            document.body.removeChild(loader);
            return pyodide;
        }

        // 初始化代码编辑器
        let codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            extraKeys: {'Tab': 'indentMore'}
        });

        // GCN完整实现代码
        codeEditor.setValue(`import numpy as np
import pickle
import os
from collections import defaultdict

class GCN:
    """图卷积网络实现"""
    
    def __init__(self, input_dim, hidden_dim, output_dim, learning_rate=0.01):
        self.input_dim = input_dim
        self.hidden_dim = hidden_dim
        self.output_dim = output_dim
        self.learning_rate = learning_rate
        
        # 权重初始化 (Xavier初始化)
        self.W1 = np.random.randn(input_dim, hidden_dim) * np.sqrt(2.0 / (input_dim + hidden_dim))
        self.b1 = np.zeros(hidden_dim)
        self.W2 = np.random.randn(hidden_dim, output_dim) * np.sqrt(2.0 / (hidden_dim + output_dim))
        self.b2 = np.zeros(output_dim)
        
    def normalize_adj(self, adj):
        """图归一化"""
        A = adj + np.eye(adj.shape[0])  # 添加自连接
        D = np.array(np.sum(A, axis=1)).flatten()
        D_inv_sqrt = np.power(D, -0.5)
        D_inv_sqrt[np.isinf(D_inv_sqrt)] = 0
        D_inv_sqrt = np.diag(D_inv_sqrt)
        return np.dot(np.dot(D_inv_sqrt, A), D_inv_sqrt)
    
    def relu(self, x):
        return np.maximum(0, x)
    
    def softmax(self, x):
        exp_x = np.exp(x - np.max(x, axis=1, keepdims=True))
        return exp_x / np.sum(exp_x, axis=1, keepdims=True)
    
    def forward(self, X, A_norm):
        """前向传播"""
        # 第一层：图卷积
        Z1 = np.dot(np.dot(A_norm, X), self.W1) + self.b1
        A1 = self.relu(Z1)
        
        # 第二层：分类
        Z2 = np.dot(np.dot(A_norm, A1), self.W2) + self.b2
        output = self.softmax(Z2)
        
        return output, A1
    
    def train_step(self, X, A_norm, labels, mask):
        """单步训练"""
        # 前向传播
        output, hidden = self.forward(X, A_norm)
        
        # 计算损失
        loss = -np.mean(np.log(output[mask, labels[mask]]))
        
        # 反向传播
        m = np.sum(mask)
        y_one_hot = np.zeros_like(output[mask])
        y_one_hot[np.arange(len(mask[mask])), labels[mask]] = 1
        
        # 计算梯度
        dZ2 = (output[mask] - y_one_hot) / m
        dW2 = np.dot(hidden[mask].T, dZ2)
        db2 = np.sum(dZ2, axis=0)
        
        dA1 = np.dot(dZ2, self.W2.T)
        dZ1 = dA1 * (hidden[mask] > 0)
        dW1 = np.dot(X[mask].T, dZ1)
        db1 = np.sum(dZ1, axis=0)
        
        # 更新权重
        self.W1 -= self.learning_rate * np.dot(np.dot(A_norm.T, dZ1).T, X).T
        self.b1 -= self.learning_rate * np.sum(np.dot(dZ1.T, A_norm), axis=1)
        self.W2 -= self.learning_rate * np.dot(np.dot(A_norm.T, dZ2).T, hidden).T
        self.b2 -= self.learning_rate * np.sum(np.dot(dZ2.T, A_norm), axis=1)
        
        return output, loss
    
    def predict(self, X, A_norm):
        """预测节点类别"""
        output, _ = self.forward(X, A_norm)
        return np.argmax(output, axis=1)

# 默认可用函数
model = GCN(1433, 16, 7)
output, embeddings = None, None`);

        let coraData = null;

        // 加载CORA数据集
        async function loadCoraData() {
            const log = document.getElementById('train-log');
            log.innerHTML = '正在加载CORA数据集...\n';
            
            try {
                if (!pyodide) await loadPyodide();
                
                // 创建模拟CORA数据
                const simulatedCora = `
import numpy as np

# CORA数据集模拟
n_nodes = 2708
n_features = 1433
n_classes = 7

# 特征矩阵 (稀疏的one-hot特征)
features = np.zeros((n_nodes, n_features))
for i in range(n_nodes):
    features[i, i % n_features] = 1  # 简化的one-hot

# 邻接矩阵 (小世界网络)
adj = np.zeros((n_nodes, n_nodes))
for i in range(n_nodes):
    for j in range(max(0, i-5), min(n_nodes, i+6)):
        if i != j:
            adj[i, j] = 1

# 标签 (7个类别)
labels = np.random.randint(0, 7, n_nodes)

# 训练/验证/测试划分
train_mask = np.array([i < 140 for i in range(n_nodes)])
val_mask = np.array([(i >= 140 and i < 640) for i in range(n_nodes)])
test_mask = np.array([(i >= 1708) for i in range(n_nodes)])

print("CORA数据集加载完成:")
print(f"节点数: {n_nodes}")
print(f"特征维度: {n_features}")
print(f"类别数: {n_classes}")
print(f"训练样本: {np.sum(train_mask) if hasattr(train_mask, 'sum') else sum(train_mask)}")
print(f"验证样本: {np.sum(val_mask) if hasattr(val_mask, 'sum') else sum(val_mask)}")
print(f"测试样本: {np.sum(test_mask) if hasattr(test_mask, 'sum') else sum(test_mask)}")
`;
                
                await pyodide.runPythonAsync(simulatedCora);
                
                coraData = {
                    features: 'features',
                    adj: 'adj',
                    labels: 'labels',
                    train_mask: 'train_mask',
                    val_mask: 'val_mask',
                    test_mask: 'test_mask'
                };
                
                log.innerHTML += '数据集加载成功！\\n';
                
            } catch (error) {
                log.innerHTML += `加载失败: ${error}\\n`;
            }
        }

        // 运行GCN训练
        async function runGCN() {
            const log = document.getElementById('train-log');
            
            if (!coraData) {
                log.innerHTML += '请先加载数据集\\n';
                return;
            }
            
            trainingActive = true;
            
            try {
                const code = codeEditor.getValue();
                await pyodide.runPythonAsync(code);
                
                const hiddenDim = parseInt(document.getElementById('hidden_dim').value);
                const learningRate = parseFloat(document.getElementById('learning_rate').value);
                const epochs = parseInt(document.getElementById('epochs').value);
                
                const trainingCode = `
from sklearn.metrics import accuracy_score

# GCN训练过程
model = GCN(n_features, ${hiddenDim}, n_classes, learning_rate=${learningRate})
accuracies = []
losses = []

# 正常化邻接矩阵
A_norm = model.normalize_adj(adj)

for epoch in range(${epochs}):
    # 训练步骤
    output, loss = model.train_step(features, A_norm, labels, train_mask)
    
    # 计算准确率
    if epoch % 2 == 0:
        pred = model.predict(features, A_norm)
        train_acc = accuracy_score(labels[train_mask], pred[train_mask])
        val_acc = accuracy_score(labels[val_mask], pred[val_mask])
        test_acc = accuracy_score(labels[test_mask], pred[test_mask])
        
        accuracies.append((epoch, train_acc, val_acc, test_acc))
        losses.append((epoch, loss))
        
        print(f"Epoch {epoch}: Loss={loss:.4f}, Train={train_acc:.4f}, Val={val_acc:.4f}, Test={test_acc:.4f}")

# 最终结果
final_pred = model.predict(features, A_norm)
final_test_acc = accuracy_score(labels[test_mask], final_pred[test_mask])
print(f"最终测试准确率: {final_test_acc:.4f}")

accuracies, losses, final_test_acc`};

                await pyodide.runPythonAsync(trainingCode);
                
                log.innerHTML += '训练完成！\\n';
                
            } catch (error) {
                log.innerHTML += `训练出错: ${error}\\n`;
            }
        }

        // 停止训练
        function stopTraining() {
            trainingActive = false;
            document.getElementById('train-log').innerHTML += '训练已停止\\n';
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadPyodide().then(() => {
                loadCoraData();
            });
        });
    </script>
</body>
</html>